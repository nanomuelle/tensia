<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tensia</title>

    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- Meta tags para instalaci√≥n en iOS (Safari no usa el manifest para esto) -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Tensia" />
    <meta name="theme-color" content="#2563eb" />

    <link rel="stylesheet" href="styles.css" />

    <!-- Mapa de importaci√≥n para D3 (sin bundler ‚Äî ADR-003, ADR-006) -->
    <!-- El SW cachea estas URLs para uso offline -->
    <script type="importmap">
    {
      "imports": {
        "d3-selection": "https://cdn.jsdelivr.net/npm/d3-selection@3/+esm",
        "d3-scale":     "https://cdn.jsdelivr.net/npm/d3-scale@4/+esm",
        "d3-axis":      "https://cdn.jsdelivr.net/npm/d3-axis@3/+esm",
        "d3-shape":     "https://cdn.jsdelivr.net/npm/d3-shape@3/+esm"
      }
    }
    </script>
  </head>
  <body>
    <!-- Aviso informativo Safari/iOS: localStorage puede borrarse tras 7 d√≠as de inactividad (ITP) -->
    <!-- Se muestra solo en iOS/Safari mediante JS inline; se oculta por defecto con hidden -->
    <div
      id="aviso-ios"
      class="aviso-ios"
      role="alert"
      aria-live="polite"
      hidden
    >
      <span>‚ö†Ô∏è En Safari/iOS los datos pueden borrarse si no usas la app durante 7 d√≠as.</span>
      <button
        id="btn-cerrar-aviso-ios"
        class="aviso-ios__cerrar"
        aria-label="Cerrar aviso"
      >‚úï</button>
    </div>
    <!-- Header fijo -->
    <header class="header">
      <span class="header__logo" aria-hidden="true">ü©∫</span>
      <h1 class="header__title">Tensia</h1>
    </header>

    <main class="main">
      <!-- Bot√≥n de acci√≥n principal -->
      <section class="nueva-medicion">
        <button
          id="btn-nueva-medicion"
          class="btn btn--primario"
          aria-label="Registrar nueva medici√≥n"
        >
          + Nueva medici√≥n
        </button>
      </section>

      <!-- Formulario de registro manual (oculto por defecto) -->
      <section
        id="formulario-registro"
        class="formulario-registro"
        aria-label="Registro de medici√≥n manual"
        hidden
      >
        <h2 class="formulario__titulo">Nueva medici√≥n</h2>

        <form id="form-medicion" novalidate>
          <!-- Sist√≥lica -->
          <div class="campo">
            <label class="campo__label" for="input-systolic">
              Sist√≥lica <span class="campo__requerido" aria-hidden="true">*</span>
            </label>
            <div class="campo__fila">
              <input
                id="input-systolic"
                name="systolic"
                type="number"
                class="campo__input"
                inputmode="numeric"
                min="1"
                placeholder="ej. 120"
                required
                aria-required="true"
                aria-describedby="error-systolic"
              />
              <span class="campo__unidad" aria-hidden="true">mmHg</span>
            </div>
            <span id="error-systolic" class="campo__error" role="alert" hidden></span>
          </div>

          <!-- Diast√≥lica -->
          <div class="campo">
            <label class="campo__label" for="input-diastolic">
              Diast√≥lica <span class="campo__requerido" aria-hidden="true">*</span>
            </label>
            <div class="campo__fila">
              <input
                id="input-diastolic"
                name="diastolic"
                type="number"
                class="campo__input"
                inputmode="numeric"
                min="1"
                placeholder="ej. 80"
                required
                aria-required="true"
                aria-describedby="error-diastolic"
              />
              <span class="campo__unidad" aria-hidden="true">mmHg</span>
            </div>
            <span id="error-diastolic" class="campo__error" role="alert" hidden></span>
          </div>

          <!-- Pulso (opcional) -->
          <div class="campo">
            <label class="campo__label" for="input-pulse">
              Pulso <span class="campo__opcional">(opcional)</span>
            </label>
            <div class="campo__fila">
              <input
                id="input-pulse"
                name="pulse"
                type="number"
                class="campo__input"
                inputmode="numeric"
                min="1"
                placeholder="ej. 72"
                aria-describedby="error-pulse"
              />
              <span class="campo__unidad" aria-hidden="true">ppm</span>
            </div>
            <span id="error-pulse" class="campo__error" role="alert" hidden></span>
          </div>

          <!-- Fecha y hora -->
          <div class="campo">
            <label class="campo__label" for="input-fecha">
              Fecha y hora <span class="campo__requerido" aria-hidden="true">*</span>
            </label>
            <input
              id="input-fecha"
              name="measuredAt"
              type="datetime-local"
              class="campo__input campo__input--fecha"
              required
              aria-required="true"
              aria-describedby="error-fecha"
            />
            <span id="error-fecha" class="campo__error" role="alert" hidden></span>
          </div>

          <!-- Error global del formulario (validaci√≥n de dominio o error inesperado) -->
          <div id="error-formulario" class="formulario__error" role="alert" hidden></div>

          <!-- Acciones -->
          <div class="formulario__acciones">
            <button type="submit" id="btn-guardar" class="btn btn--primario">
              Guardar medici√≥n
            </button>
            <button type="button" id="btn-cancelar" class="btn btn--secundario">
              Cancelar
            </button>
          </div>
        </form>
      </section>

      <!-- Secci√≥n gr√°fica (BK-14 / ADR-006): visible cuando hay ‚â• 2 mediciones -->
      <section id="seccion-grafica" class="grafica-seccion" hidden>
        <div class="grafica-header">
          <h2 class="grafica__titulo">Evoluci√≥n</h2>
          <span class="grafica__unidad" aria-hidden="true">mmHg</span>
        </div>
        <!-- Leyenda: aria-hidden porque el aria-label del SVG ya describe la gr√°fica -->
        <div class="grafica__leyenda" aria-hidden="true">
          <span class="leyenda-pill leyenda-pill--sistolica">Sist√≥lica</span>
          <span class="leyenda-pill leyenda-pill--diastolica">Diast√≥lica</span>
        </div>
        <div class="grafica-contenedor">
          <!-- div en lugar de canvas (ADR-006): D3 inserta el SVG aqu√≠ -->
          <div id="chart-mediciones"></div>
        </div>
      </section>

      <!-- Secci√≥n historial -->
      <section class="historial">
        <h2 class="historial__titulo">Historial</h2>

        <!-- Estado: cargando -->
        <div
          id="estado-cargando"
          class="estado estado--cargando"
          aria-live="polite"
          aria-label="Cargando"
          hidden
        >
          <span class="spinner" aria-hidden="true"></span>
          <span>Cargando mediciones‚Ä¶</span>
        </div>

        <!-- Estado: error -->
        <div
          id="estado-error"
          class="estado estado--error"
          role="alert"
          hidden
        >
          <span>‚ö†Ô∏è No se pudieron cargar las mediciones.</span>
          <button id="btn-reintentar" class="btn btn--secundario">
            Reintentar
          </button>
        </div>

        <!-- Estado: sin mediciones -->
        <div id="estado-vacio" class="estado estado--vacio" hidden>
          <p>Sin mediciones todav√≠a.</p>
          <p>Pulsa "Nueva medici√≥n" para registrar la primera.</p>
        </div>

        <!-- Lista de mediciones -->
        <ul
          id="lista-mediciones"
          class="lista-mediciones"
          role="list"
          aria-label="Historial de mediciones"
        ></ul>
      </section>
    </main>

    <script type="module" src="src/app.js"></script>

    <!-- Registro del Service Worker y l√≥gica del aviso iOS -->
    <script>
      // Registro del SW (solo si el navegador lo soporta)
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch((err) => {
          console.warn('[Tensia] No se pudo registrar el Service Worker:', err);
        });
      }

      // Aviso informativo en Safari/iOS (pol√≠tica ITP: datos borrados tras 7 d√≠as de inactividad)
      const esIOS = /iP(hone|od|ad)/.test(navigator.userAgent);
      const esSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      if (esIOS || esSafari) {
        const aviso = document.getElementById('aviso-ios');
        if (aviso) aviso.hidden = false;
      }
      document.getElementById('btn-cerrar-aviso-ios')?.addEventListener('click', () => {
        document.getElementById('aviso-ios').hidden = true;
      });
    </script>
  </body>
</html>
